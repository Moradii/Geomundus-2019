---
title: Retrieve and process satellite images time series towards data analysis in
  R
author: Montesino-SanMartin, M., Perez-Goya, U., Moradi, M., Ugarte, M.D., Militino,
  A.F.
date: "UPNA"
output:
  html_document:
    theme: cosmo
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
bibliography: refs.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

![](./figures/logo.png){width=30%}

License: All the original materials used in this workshop are available under [CC-BY-SA](https://creativecommons.org/licenses/by-sa/2.0/).

# Overview

## Reasons

There are several packages in `R` dealing with satellite images (e.g., 
`MODISTools` or `satellite`). So, why developing a new package?

  - **Centralize**: Three major sources of freely accessible satellite images;
  Landsat, MODIS, and Sentinel. Their combination increases the spatio-temporal
  resolution of the remotely sensed information (e.g., data fusion techniques
  as in @df2019). A *single access point* can foster multi-program
  imagery analyses.
  
  - **Standardize**: Satellite programs differ in their data standards and
  formats (compression formats, naming conventions, bands, tiling systems,
  etc.). Web services offer different sharing protocols (GUIs and APIs) and
  data products. Programming can deal with this complexity in the background
  and offer *consistent experience* to the user.
  
  - **Automate**: The analysis of the earth's surface patterns and dynamics
  frequently requires long series of images. Also, data-sets must undergo
  multiple transformations from acquisition to analysis. We found convenient
  to develop a *comprehensive* package and facilitates the use of 
  *computationally efficient* routines.

## Workflow

There is a large number of functions in `RGISTools`. Functions are named in a
systematic way to easily find the function best suited for an specific 
satellite program and purpose:

  1. A *prefix* of the function's name indicates the data source:

  - **Landsat program**:
    * `ls`: Functions devoted to Landsat imagery.
       - `ls7`: for Landsat-7.
       - `ls8`: for Landsat-8.
  - **MODIS program**:
    * `mod`: Functions devoted to MODIS imagery.
  - **Copernicus program**:
    * `sen`: Functions devoted to Sentinel(-2) imagery.
  
  2. A *suffix* reflects the functionality:

  - **Retrieve**: getting data
    * `Search`: find imagery for a given ROI and time-span.
    * `Preview`: inspect the overlap with ROI and cloud coverage.
    * `Download`: acquire images massively. 
  - **Customize**: manufacturing data
    * `Mosaic`: bind tiles and clip the extent of ROI.
    * `FolderToVar`: calculate indexes, such as NDVI.
  - **Process**: cleaning data
    * `CloudMask`: remove the values of cloudy pixels.
    * `Composition`: generate regular series and improve image quality.
    * `SmoothingIMA`: gap-filling and smoothing data to resolve missing values
    and outliers [@militino2019].

For instance, the function that downloads Sentinel images is called 
`senDownload()`. There are other functions in the package not mentioned
in this list.

---

# Demo

Today's demo: 

 * Analyze change-points patterns in a time-series of images of the normalized
 difference vegetation index (NDVI) - an indicator of vegetation greenness - and
 the land surface temperatures (LST).
 * The analysis concerns Castell贸n (Spain) and Nordrhein-Westfalen (Germany).
 * The time period of analysis is 2001 and 2018.

In this first session:

  * Download and customize (*a sample of*) the data-set for the analysis.
  * Walk-through with Castell贸n and exercises with Nordrhein-Westfalen.

## Set-outs

### The package

**Install** the latest version of the package from github, and load it:

```{r install, eval=FALSE}
library(devtools)
install_github("spatialstatisticsupna/RGISTools")
```
```{r loadpkg, message=FALSE}
library(RGISTools)
```

### Accounts

The package interacts with the **Earth Data** and **SciHub** web services. Web
services provide access to archives of satellite images. They require a profile
that you can create [here](https://urs.earthdata.nasa.gov/users/new) and 
[here](https://scihub.copernicus.eu/dhus/#/self-registration). For this workshop,
use the following credentials:

```{r credentials}
username <- "geomundus2019"
password <- "Geomundus2019"
```

### Region of interest (ROI)

Since we are dealing with administrative divisions, we use the database of
global administrative division maps provided by `raster` [@raster2019]. The
following code downloads the shape-file of Spain with its provinces:

```{r roispain}
spain <- getData('GADM', country = "Spain", level = 2)
```

From there, we select the region of Castell贸n:  

```{r roicastellon}
castellon <- subset(spain, NAME_2 == "Castell贸n")
```

We can display the results using `tmap` [@tmap2018]. The package is loaded with
`RGISTools` and used for visualization since it supports many spatial data
formats, is flexible, and allows interactive and static maps with the same code.

We set the option to display interactive maps:

```{r viewmode}
tmap_mode("view")
```

We view our `SpatialPolygonDataFrame` on a map:

```{r showroi}
tm_shape(castellon) +
  tm_polygons(col = "red") +
  tm_view(set.view = 4)
```

### Exercise

  1. Download the shape-file of `Germany`.
  2. Filter the shape-file to get the region of Nordrhein-Westfalen.

Replace the `<>` code conveniently:

```{r exercise1, eval=FALSE}
germany <- getData('GADM', country = <COUNTRYNAME>, level = 2)
nordrhein <- subset(germany, NAME_1 == <REGIONAME>)

tm_shape(nordrhein) +
  tm_polygons(col = "red") +
  tm_view(set.view = 4)
```

---

## Retrieve

### Search

The first task is to search the imagery from a data product that intersects
our ROI and covers the time period of analysis. This is the purpose of
`modSearch()`. 

The function requires the definition of:

  1. The data product (`product`): The MODIS program provides NDVI and LST
  images. These are named **MOD13A2** and **MOD11A2** respectively. The full
  catalogue of products is available [here](https://modis.gsfc.nasa.gov/data/dataprod/).
  2. The ROI (`region`): An `sf`, `Spatial*`, or `raster` class object.
  3. The time period (`dates`): A (vector of) `Date` class object (s).

```{r search}
sres.ndvi <- modSearch(product = "MOD13A2",
                       region = castellon,
                       dates = seq(as.Date("2001-01-01"),
                                   as.Date("2018-12-31"),1))
```

The function returns a vector of URLs with the series of MODIS images concerning
our ROI and relevant time-period. We can extract useful information from the
results like:

The total number of images that are found:

```{r noimgs}
length(sres.ndvi)
```

The tiles intersecting our ROI with `modGetPathRow()`:

```{r tiles}
sres.tileid <- unique(modGetPathRow(sres.ndvi))
sres.tileid
```

The capturing dates of our images with `modGetDate()`:

```{r capdates}
sres.dates <- unique(modGetDates(sres.ndvi))
sres.dates[1:4]
length(sres.dates)
```

Results show that there are 1656 images, as a combination of 4 tiles (h18v05,
h17v04, h17v05, h18v04) and 414 dates (approximately, 2 n/month  x 12months/year
x 18 years). The dates confirm that time frequency of this product is 16 days. 

### Exercise

  1. Search the available images of the LST product (**MOD11A2**) intersecting
  the Nordrhein-Westfalen region (`nordrhein` variable) during the same time
  period as before.
  2. Answer the following questions:

    (a) How many images did you find?
    (b) How many tiles intersect with Nordrhein-Westfalen?
    (c) What is the temporal frequency? 

Replace the `<>` code conveniently:

```{r exercise2, eval=FALSE}
sres.lst <- modSearch(product = <PRODUCT>,
                      region = <REGION>,
                      dates = <DATES>)

tileid.lst <- <CODE>
sres.dates <- <CODE>
```

---

### Download

`RGISTools` works with satellite images locally on your computer (images stored
on disk), which has two implications:

  1. **Memory issues**:
  
  - RAM: Images are handled externally to `R` (GDAL via `sf`, @sf2019 
    whenever possible). The series of images are loaded at the end, when the
    data set contains only useful information for the analysis.
  - Disk: strategies via arguments (see below).

  2. **File management issues**: a clear hierarchy of files and folder is key.

The function `modDownload()` requires (at least):

  1. The search list (`searchres` argument) from Earth Data (`sres.ndvi`).
  2. The directory (`AppRoot` argument) where the images are placed.
  3. The credentials of an Earth Data account (`username` and `password`
  arguments).
  4. An instruction whether to convert (`extract.tif = TRUE`) the bands from
  the original files (in Hierarchical Data Format or `HDF`) into `GeoTiff`.

As an example, we download the images for the first day (4 tiles) in a new
directory `./exercises/ndvi`:

```{r download, message=FALSE}
wdir.ndvi <- file.path("./", "exercises", "ndvi")
modDownload(searchres = sres.ndvi[1:4],
            AppRoot = wdir.ndvi,
            username = "geomundus2019",
            password = "Geomundus2019",
            extract.tif = TRUE)
```

The function creates two new folders:

  * `./exercises/ndvi/hdf`: contains the HDF files.
  * `./exercises/ndvi/tif`: contains the extracted bands, being each band a
  separate `GeoTiff`.
  
This 4 images take around 51 MB and 150 MB for the `HDF` and `GeoTiff` files!
We can be more efficient by being more specific with the arguments:

  * `bFilter`: converts into `GeoTiffs` only the relevant bands.
  * `raw.rm`: removes the raw files once the `GeoTiffs` are created.

If we remove the `tif` folder:

```{r rmtif}
wdir.ndvi.tif <- file.path(wdir.ndvi, "tif")
unlink(wdir.ndvi.tif, recursive = TRUE)
```

And we run the function adding `bFilter = "NDVI"` to select only the "NDVI"
band and remove the original files by setting
`raw.rm = TRUE`:

```{r redownload, message=FALSE}
modDownload(searchres = sres.ndvi[1:4],
            AppRoot = wdir.ndvi,
            username = "geomundus2019",
            password = "Geomundus2019",
            extract.tif = TRUE,
            bFilter = "NDVI",
            raw.rm = TRUE)
```

Then, the folders:

  * `./exercises/ndvi/hdf`: has no image.
  * `./exercises/ndvi/tif`: contains one band.

We went from 201 MB to 11 MB. Note that the second time, the function run faster.
`modDownload()` detects that the original files are there and therefore, only
converts the bands to `GeoTiffs`.

### Exercise

  1. Create a new directory for the LST images.
  2. Run the function to download the first LST image.
  3. Remember to filter the bands extracted (`"LST_Day_1km"`) and
  indicate `raw.rm = TRUE`.

Replace the `<>` code conveniently:

```{r exercise3, eval=FALSE}
wdir.lst <- <LSTDIRECTORY>
modDownload(searchres = sres.lst[1],
            <MOREARGUMENTS>)
```

---

## Customize

### Mosaicking and cropping

**Mosaicking** means joining images captured on the same date but belonging to
different tiles. **Cropping** means removing the pixels outside the bounding box
of the ROI. Both tasks are carried out by `modMosaic()`, which requires:

  1. The folder directory (`src` argument) that stores the `GeoTiff`s 
  (`<DIRECTORYTIF>`).
  2. If needed, a ROI (`region` argument) around which images are cropped.
  3. The name of the folder (`out.name`) where the results will be saved.
  4. The directory (`AppRoot` argument) defined with the argument.


```{r mosaic, message=FALSE}
modMosaic(src = wdir.ndvi.tif,
          region = castellon,
          out.name = "castellon",
          AppRoot = wdir.ndvi)
```

You will notice the new folder that has been added to your `./`. The
folders are:

  * `./exercises/ndvi/hdf`: has no image.
  * `./exercises/ndvi/tif`: contains one band.
  * `./exercises/ndvi/castellon`: contains the mosaicked image.

Thanks to cropping, the size of memory storage consumed by our data set is
now roughly 0.36 MB.

### Exercise

  1. Download the file `lst_geomundus` from the github repository. 
  2. Save it in your `<DIRECTORY>`. The folder contains an image of LST
  covering Nordrhein-Westfalen captured on 2018-01-01 by MODIS Terra.
  3. Mosaic and crop the image around Nordrhein-Westfalen (`nordhrein`
  variable).

Replace the `<>` code conveniently:

```{r exercise4, eval=FALSE}
wdir.lst.tif <- <LSTDIRECTORYTIF>
modMosaic(src = wdir.lst.tif,
          AppRoot = "<LSTDIRECTORY>",
          <MOREARGUMENTS>)
```

---

## Import and visualize

We can import the imagery using the `stack()` function from the `raster` package
[@raster2019], as follows:

```{r import, message=FALSE}
wdir.ndvi.mos <- file.path(wdir.ndvi, "castellon")
files.ndvi <- list.files(wdir.ndvi.mos, full.names = TRUE, recursive = TRUE)
imgs.ndvi <- stack(files.ndvi)
```

Pixels values are between -32768 and 32768. It is necessary to re-scale the
image to the [-1,1] NDVI range. Information about the scaling parameter
can be found in the [product catalogue](https://lpdaac.usgs.gov/products/mod13a2v006/).
There, we find that the re-scaling factor is 0.0001:

```{r rescale}
imgs.ndvi <- imgs.ndvi * 0.0001
```

`RGISTools` has the `genPlotGIS()` function to help you visualize your data.
It a wrapper function of `tmap` [@tmap2018]. The basic inputs are:

  1. A `RasterStack` of satellite images (`r` argument).
  2. The ROI (`region` argument).

```{r showndvi, message=FALSE}
tmap_mode("view")
genPlotGIS(r = imgs.ndvi,
           region = castellon,
           tm.raster.r.title = "NDVI",
           tm.raster.r.alpha = 0.35)
```

### Exercise

  1. Import your LST image. 
  2. Find out if the image must to be re-scaled and, if so, apply the scaling
  factor.
  [hint](https://lpdaac.usgs.gov/products/mod11a2v006/).
  3. Show your results on a map.
  
Replace the `<>` code conveniently:

```{r exercise5, eval=FALSE}
wdir.lst <- <LSTDIRECTORYMOSAIC>
files.lst <- list.files(wdir.lst, full.names = TRUE, recursive = TRUE)
imgs.lst <- stack(files.lst)

scale.factor <- "<SCALEFACTOR>" # no re-scaling, set to 1 
imgs.lst <- imgs.lst * scale.factor
genPlotGIS(<CODE>)
```

---

## Concluding remarks

  * The package is a way to access, customize, and process time-series of 
  satellite imagery from several platforms.
  * As an introduction, we downloaded and customized MODIS LST and NDVI images
  for two locations: Castellon (Spain) and Nordhrein-Westfalen (Germany).
  * Being memory efficient is key to work locally with satellite images. The
  package offers several strategies (band filtering, mosaicking, GDAL, etc.).
  * It is crucial to develop a clear hierarchy of files and folders 
  created in each step.
  * The walk-through and exercises focused on MODIS, but multispectral data
  from other satellite programs can be similarly retrieved.
  * The walk-through and exercises cover the download and customization, and
  neglects the processing (cloud masking, compositing, and filling-smoothing).

Stay tuned for new vignettes at:
https://github.com/spatialstatisticsupna/RGISTools

# References